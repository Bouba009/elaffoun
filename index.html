<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>العفرون أونلاين | El Affroun Online</title>
    <!-- خط كايرو لدعم العربية بشكل جميل -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- أيقونات FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ==================== 1. General Styles ==================== */
        :root {
            --primary: #f26522; /* لون شبيه بواد كنيس (برتقالي) */
            --secondary: #003d7a; /* أزرق داكن */
            --bg-light: #f4f6f8;
            --white: #ffffff;
            --text-dark: #333;
            --text-gray: #666;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --transition: 0.3s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background-color: var(--bg-light); color: var(--text-dark); overflow-x: hidden; }
        a { text-decoration: none; color: inherit; }
        ul { list-style: none; }
        button, input, select, textarea { outline: none; border: none; font-family: inherit; }
        
        /* أدوات مساعدة */
        .hidden { display: none !important; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .btn { padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: var(--transition); font-weight: 600; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: #d94e0d; }
        .btn-secondary { background-color: var(--secondary); color: white; }
        .btn-secondary:hover { background-color: #002a55; }
        .btn-outline { border: 1px solid var(--secondary); color: var(--secondary); background: transparent; }

        /* ==================== 2. Navbar ==================== */
        header { background-color: var(--white); box-shadow: var(--shadow); position: sticky; top: 0; z-index: 1000; }
        .nav-content { display: flex; justify-content: space-between; align-items: center; height: 70px; }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--secondary); }
        .logo span { color: var(--primary); }
        .nav-links { display: flex; gap: 20px; align-items: center; }
        .nav-links a { font-weight: 600; color: var(--text-dark); transition: var(--transition); cursor: pointer; }
        .nav-links a:hover { color: var(--primary); }

        /* ==================== 3. Hero Section ==================== */
        .hero { 
            position: relative; 
            height: 90vh; 
            overflow: hidden; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            text-align: center;
            color: white;
        }
        .hero-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://images.unsplash.com/photo-1472851294608-41531268f719?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            z-index: -1;
            animation: zoomEffect 20s infinite alternate;
        }
        .hero-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: -1;
        }
        @keyframes zoomEffect {
            0% { transform: scale(1); }
            100% { transform: scale(1.2); }
        }
        .hero h1 { font-size: 3rem; margin-bottom: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .hero p { font-size: 1.2rem; margin-bottom: 30px; }
        .hero-btn { 
            padding: 15px 40px; font-size: 1.2rem; background: var(--primary); color: white; 
            border-radius: 50px; cursor: pointer; transition: 0.3s;
        }
        .hero-btn:hover { transform: translateY(-5px); background: #d94e0d; }

        /* ==================== 4. Ads Area ==================== */
        #market-section { padding: 40px 0; }
        
        /* Banner Ads */
        .top-banner { 
            width: 100%; height: 120px; background-color: #ddd; margin-bottom: 20px; 
            border-radius: 8px; overflow: hidden; position: relative; display: none;
        }
        .top-banner img { width: 100%; height: 100%; object-fit: cover; }

        /* Grid Layout */
        .ads-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
            gap: 20px; 
        }

        /* Ad Card */
        .ad-card {
            background: white; border-radius: 8px; overflow: hidden;
            box-shadow: var(--shadow); transition: var(--transition);
            position: relative;
        }
        .ad-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.15); }
        .ad-image { height: 180px; width: 100%; overflow: hidden; }
        .ad-image img { width: 100%; height: 100%; object-fit: cover; }
        .ad-content { padding: 15px; }
        .ad-price { color: var(--primary); font-weight: 700; font-size: 1.1rem; }
        .ad-title { font-size: 1rem; margin: 5px 0; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ad-meta { font-size: 0.8rem; color: var(--text-gray); display: flex; justify-content: space-between; margin-top: 10px; }
        .ad-featured-badge {
            position: absolute; top: 10px; right: 10px; background: #ffc107; color: #000;
            padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .featured-card { border: 2px solid #ffc107; }

        /* ==================== 5. Floating Buttons ==================== */
        .fab-container { position: fixed; bottom: 30px; left: 30px; display: flex; flex-direction: column; gap: 10px; z-index: 900; }
        .fab {
            width: 50px; height: 50px; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: 0.3s;
        }
        .fab-add { background-color: var(--primary); }
        .fab-filter { background-color: var(--secondary); }
        .fab:hover { transform: scale(1.1); }
        
        /* ==================== 6. Modals ==================== */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal.active { opacity: 1; pointer-events: all; }
        .modal-content {
            background: white; width: 90%; max-width: 500px; padding: 25px;
            border-radius: 10px; position: relative; max-height: 90vh; overflow-y: auto;
        }
        .close-modal { position: absolute; top: 15px; left: 15px; font-size: 1.2rem; cursor: pointer; color: #999; }
        
        .form-group { margin-bottom: 15px; text-align: right; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .form-control {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;
            font-size: 1rem; transition: 0.3s;
        }
        .form-control:focus { border-color: var(--primary); }
        
        /* Filter Modal specifics */
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        /* Admin Controls */
        .admin-controls { margin-top: 10px; border-top: 1px solid #eee; padding-top: 5px; display: flex; gap: 5px; }
        .btn-sm { font-size: 0.7rem; padding: 5px 8px; }

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
            border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;
            margin: 20px auto; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* رسائل التنبيه */
        .toast {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 10px 20px; border-radius: 5px;
            z-index: 3000; font-size: 0.9rem; display: none;
        }
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }

    </style>
</head>
<body>

    <!-- رسائل التنبيه -->
    <div id="toast" class="toast">تمت العملية بنجاح</div>

    <!-- Header -->
    <header>
        <div class="container nav-content">
            <div class="logo">
                El Affroun <span>Online</span>
            </div>
            <nav class="nav-links">
                <a href="#" onclick="showSection('hero')">الرئيسية</a>
                <div id="auth-buttons">
                    <a href="#" onclick="openModal('loginModal')"><i class="fas fa-user"></i> دخول</a>
                </div>
                <div id="user-menu" class="hidden" style="display: flex; gap: 15px; align-items: center;">
                    <span id="user-name" style="font-size: 0.9rem;"></span>
                    <a href="#" onclick="logoutUser()" style="color:red"><i class="fas fa-sign-out-alt"></i> خروج</a>
                </div>
                <a href="#market-section" onclick="showMarket()"><i class="fas fa-search"></i> بحث</a>
            </nav>
        </div>
    </header>

    <!-- Hero Section -->
    <section id="hero" class="hero">
        <div class="hero-bg"></div>
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <h1>العفرون أونلاين <br> <span style="font-size: 1.5rem; font-weight: 300;">El Affroun Online</span></h1>
            <p>بيع وشراء المنتجات بسهولة في منطقتك</p>
            <button class="hero-btn" onclick="showMarket()">ابدأ الآن <i class="fas fa-arrow-left"></i></button>
        </div>
    </section>

    <!-- Market Section (Hidden initially) -->
    <section id="market-section" class="container hidden">
        
        <!-- Banner Ad (Admin) -->
        <div id="top-banner" class="top-banner">
            <a href="#" id="banner-link" target="_blank">
                <img id="banner-img" src="" alt="Advertisement">
            </a>
        </div>

        <h2 style="margin-bottom: 20px; color: var(--secondary);">أحدث الإعلانات</h2>
        
        <!-- Loader -->
        <div id="loader" class="loader"></div>

        <!-- Grid -->
        <div id="ads-container" class="ads-grid">
            <!-- سيتم حقن الإعلانات هنا بواسطة JS -->
        </div>
    </section>

    <!-- Floating Buttons -->
    <div class="fab-container hidden" id="fab-actions">
        <button class="fab fab-filter" onclick="openModal('filterModal')" title="فلترة"><i class="fas fa-filter"></i></button>
        <button class="fab fab-add" onclick="checkAuthAndOpenAdd()" title="نشر إعلان"><i class="fas fa-plus"></i></button>
    </div>

    <!-- ==================== Modals ==================== -->

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('loginModal')">&times;</span>
            <h3 style="text-align: center; margin-bottom: 20px;">تسجيل الدخول</h3>
            <form id="loginForm">
                <div class="form-group">
                    <label>البريد الإلكتروني / Email</label>
                    <input type="email" id="login-email" class="form-control" placeholder="user@example.com" required>
                </div>
                <div class="form-group">
                    <label>كلمة المرور / Password</label>
                    <input type="password" id="login-password" class="form-control" placeholder="******" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">دخول</button>
                <p style="text-align: center; margin-top: 15px; font-size: 0.9rem;">
                    ليس لديك حساب؟ <a href="#" onclick="closeModal('loginModal'); openModal('signupModal')" style="color: var(--primary);">أنشئ حساباً</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signupModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('signupModal')">&times;</span>
            <h3 style="text-align: center; margin-bottom: 20px;">إنشاء حساب جديد</h3>
            <form id="signupForm">
                <div class="form-group">
                    <label>الاسم الكامل</label>
                    <input type="text" id="reg-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>البريد الإلكتروني</label>
                    <input type="email" id="reg-email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>رقم الهاتف</label>
                    <input type="text" id="reg-phone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>كلمة المرور</label>
                    <input type="password" id="reg-pass" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>تأكيد كلمة المرور</label>
                    <input type="password" id="reg-confirm-pass" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">تسجيل</button>
            </form>
        </div>
    </div>

    <!-- Add Ad Modal -->
    <div id="addAdModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('addAdModal')">&times;</span>
            <h3 style="text-align: center; margin-bottom: 20px;">نشر إعلان جديد</h3>
            <form id="addAdForm">
                <div class="form-group">
                    <label>الفئة</label>
                    <select id="ad-category" class="form-control" required>
                        <option value="">اختر الفئة...</option>
                        <option value="vehicles">سيارات و مركبات</option>
                        <option value="real_estate">عقارات</option>
                        <option value="electronics">هواتف و إلكترونيات</option>
                        <option value="jobs">وظائف</option>
                        <option value="services">خدمات</option>
                        <option value="appliances">أجهزة كهرومنزلية</option>
                        <option value="fashion">ألبسة و موضة</option>
                        <option value="professional">معدات مهنية</option>
                        <option value="others">أخرى</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>العنوان</label>
                    <input type="text" id="ad-title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>السعر (DZD)</label>
                    <input type="number" id="ad-price" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>المدينة</label>
                    <select id="ad-city" class="form-control" required>
                        <option value="العفرون">العفرون</option>
                        <option value="موزاية">موزاية</option>
                        <option value="شفة">شفة</option>
                        <option value="واد جر">واد جر</option>
                        <option value="احمر العين">احمر العين</option>
                        <option value="حطاطبة">حطاطبة</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>رقم الهاتف</label>
                    <input type="text" id="ad-phone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>الوصف</label>
                    <textarea id="ad-desc" class="form-control" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label>صورة المنتج</label>
                    <input type="file" id="ad-image" class="form-control" accept="image/*" required>
                </div>
                
                <!-- خيارات الأدمن فقط -->
                <div id="admin-ad-options" class="hidden" style="background: #f9f9f9; padding: 10px; border: 1px dashed red;">
                    <label><input type="checkbox" id="is-admin-ad"> إعلان إداري (بانر/مميز)</label>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">نشر الإعلان</button>
            </form>
        </div>
    </div>

    <!-- Filter Modal -->
    <div id="filterModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('filterModal')">&times;</span>
            <h3 style="text-align: center;">فلترة البحث</h3>
            <div class="form-group">
                <label>الفئة</label>
                <select id="filter-category" class="form-control">
                    <option value="all">الكل</option>
                    <option value="vehicles">سيارات و مركبات</option>
                    <option value="real_estate">عقارات</option>
                    <option value="electronics">هواتف و إلكترونيات</option>
                    <option value="jobs">وظائف</option>
                    <option value="services">خدمات</option>
                    <option value="appliances">أجهزة كهرومنزلية</option>
                    <option value="fashion">ألبسة و موضة</option>
                    <option value="professional">معدات مهنية</option>
                    <option value="others">أخرى</option>
                </select>
            </div>
            <div class="form-group">
                <label>المدينة</label>
                <select id="filter-city" class="form-control">
                    <option value="all">الكل</option>
                    <option value="العفرون">العفرون</option>
                    <option value="موزاية">موزاية</option>
                    <option value="شفة">شفة</option>
                    <option value="واد جر">واد جر</option>
                    <option value="احمر العين">احمر العين</option>
                    <option value="حطاطبة">حطاطبة</option>
                </select>
            </div>
            <div class="filter-grid">
                <div class="form-group">
                    <label>السعر الأدنى</label>
                    <input type="number" id="filter-min-price" class="form-control" placeholder="0">
                </div>
                <div class="form-group">
                    <label>السعر الأقصى</label>
                    <input type="number" id="filter-max-price" class="form-control" placeholder="MAX">
                </div>
            </div>
            <button onclick="applyFilters()" class="btn btn-secondary" style="width: 100%;">تطبيق الفلتر</button>
        </div>
    </div>

    <!-- Ad Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('detailsModal')">&times;</span>
            <div id="details-content">
                <!-- محتوى التفاصيل -->
            </div>
        </div>
    </div>

    <!-- ==================== JavaScript ==================== -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, query, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAaXp-gUOQ_G2s-kM8JhaqW8TJcJ4Nqcuo",
            authDomain: "comondi-fae4b.firebaseapp.com",
            projectId: "comondi-fae4b",
            storageBucket: "comondi-fae4b.firebasestorage.app",
            messagingSenderId: "932777870241",
            appId: "1:932777870241:web:78b0cf3a3cf14046be01e0",
            measurementId: "G-M09RX0V18S"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // State Management
        let currentUser = null;
        let isAdmin = false;
        let allAds = []; // لتخزين الإعلانات محلياً للفلترة السريعة
        
        // Admin Credentials Check (Simulated for this frontend-only scope)
        // في الواقع يجب أن يكون هذا باستخدام Custom Claims في Firebase Auth
        const ADMIN_EMAIL_CHECK = "admin@elaffroun.com"; // مثال
        // بما أن المستخدم طلب دخول الأدمن بكلمة مرور معينة، سنقوم بالتحقق عند تسجيل الدخول

        // ==================== Auth Functions ====================

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-buttons').classList.add('hidden');
                document.getElementById('user-menu').classList.remove('hidden');
                document.getElementById('user-menu').style.display = 'flex';
                document.getElementById('user-name').innerText = user.email.split('@')[0];
                document.getElementById('fab-actions').classList.remove('hidden'); // إظهار الأزرار العائمة

                // Check Admin
                if (user.email === 'admin' || user.email === ADMIN_EMAIL_CHECK || user.email === "admin@gmail.com") {
                    isAdmin = true;
                    document.getElementById('admin-ad-options').classList.remove('hidden');
                } else {
                    isAdmin = false;
                    document.getElementById('admin-ad-options').classList.add('hidden');
                }
            } else {
                currentUser = null;
                isAdmin = false;
                document.getElementById('auth-buttons').classList.remove('hidden');
                document.getElementById('user-menu').classList.add('hidden');
                document.getElementById('fab-actions').classList.add('hidden');
            }
        });

        // Login Handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const emailInput = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            
            // محاكاة دخول الأدمن المذكور في الطلب
            let email = emailInput;
            if (emailInput === "admin") {
                email = "admin@elaffroun.com"; // تحويل اسم المستخدم إلى إيميل للتوافق مع فايربيس
            }

            try {
                await signInWithEmailAndPassword(auth, email, pass);
                closeModal('loginModal');
                showToast('تم تسجيل الدخول بنجاح', 'success');
            } catch (error) {
                showToast('خطأ: ' + error.message, 'error');
            }
        });

        // Signup Handler
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const confirmPass = document.getElementById('reg-confirm-pass').value;
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;

            if (pass !== confirmPass) {
                showToast('كلمتا المرور غير متطابقتين', 'error');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                // يمكن تخزين الاسم والهاتف في Firestore collection "users" هنا
                closeModal('signupModal');
                showToast('تم إنشاء الحساب بنجاح', 'success');
            } catch (error) {
                showToast('خطأ: ' + error.message, 'error');
            }
        });

        window.logoutUser = () => {
            signOut(auth).then(() => {
                showToast('تم تسجيل الخروج', 'success');
                window.location.reload();
            });
        };

        // ==================== Ad Functions ====================

        // Upload Image
        async function uploadImage(file) {
            const storageRef = ref(storage, 'ads/' + Date.now() + '_' + file.name);
            const snapshot = await uploadBytes(storageRef, file);
            return await getDownloadURL(snapshot.ref);
        }

        // Add Ad
        document.getElementById('addAdForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            showLoader(true);
            try {
                const category = document.getElementById('ad-category').value;
                const title = document.getElementById('ad-title').value;
                const price = parseFloat(document.getElementById('ad-price').value);
                const city = document.getElementById('ad-city').value;
                const phone = document.getElementById('ad-phone').value;
                const desc = document.getElementById('ad-desc').value;
                const file = document.getElementById('ad-image').files[0];
                const isAdminAd = document.getElementById('is-admin-ad').checked;

                const imageUrl = await uploadImage(file);

                await addDoc(collection(db, "ads"), {
                    title,
                    price,
                    category,
                    city,
                    phone,
                    description: desc,
                    imageUrl,
                    userId: currentUser.uid,
                    createdAt: serverTimestamp(),
                    isAdminAd: isAdmin && isAdminAd, // فقط الأدمن يمكنه جعلها True
                    isFeatured: isAdmin && isAdminAd // الافتراضي
                });

                closeModal('addAdModal');
                document.getElementById('addAdForm').reset();
                showToast('تم نشر الإعلان بنجاح!', 'success');
                getAds(); // Refresh
            } catch (error) {
                console.error(error);
                showToast('حدث خطأ أثناء النشر', 'error');
            } finally {
                showLoader(false);
            }
        });

        // Get Ads & Display
        async function getAds() {
            showLoader(true);
            const container = document.getElementById('ads-container');
            container.innerHTML = '';
            
            try {
                // Fetch Ads
                const q = query(collection(db, "ads"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                allAds = [];
                querySnapshot.forEach((doc) => {
                    allAds.push({ id: doc.id, ...doc.data() });
                });

                // Fetch Admin Banner (Simulated Logic from Ads collection where isAdminAd is true and position is top)
                // في هذا الكود البسيط سأعرض أول إعلان مميز كبانر إذا وجد
                const bannerAd = allAds.find(ad => ad.isAdminAd === true);
                if (bannerAd) {
                    document.getElementById('top-banner').style.display = 'block';
                    document.getElementById('banner-img').src = bannerAd.imageUrl;
                }

                renderAds(allAds);

            } catch (error) {
                console.error("Error getting documents: ", error);
            } finally {
                showLoader(false);
            }
        }

        function renderAds(adsList) {
            const container = document.getElementById('ads-container');
            container.innerHTML = '';

            // Randomize order logic as requested (optional, here I kept sorting by date then random on display)
            // adsList.sort(() => Math.random() - 0.5); 

            adsList.forEach(ad => {
                const isFeatured = ad.isFeatured ? 'featured-card' : '';
                const badge = ad.isFeatured ? '<span class="ad-featured-badge"><i class="fas fa-star"></i> مميز</span>' : '';
                
                let adminBtns = '';
                if (isAdmin) {
                    adminBtns = `
                        <div class="admin-controls">
                            <button onclick="deleteAd('${ad.id}')" class="btn btn-sm" style="background:red; color:white;">حذف</button>
                            <button onclick="toggleFeatured('${ad.id}', ${!ad.isFeatured})" class="btn btn-sm" style="background:#ffc107;">${ad.isFeatured ? 'إلغاء التميز' : 'تميز'}</button>
                        </div>
                    `;
                }

                const html = `
                    <div class="ad-card ${isFeatured}">
                        ${badge}
                        <div class="ad-image" onclick="showAdDetails('${ad.id}')">
                            <img src="${ad.imageUrl}" alt="${ad.title}">
                        </div>
                        <div class="ad-content">
                            <div class="ad-price">${ad.price.toLocaleString()} DZD</div>
                            <h3 class="ad-title">${ad.title}</h3>
                            <div class="ad-meta">
                                <span><i class="fas fa-map-marker-alt"></i> ${ad.city}</span>
                                <span><i class="fas fa-tag"></i> ${getCategoryName(ad.category)}</span>
                            </div>
                            <button class="btn btn-outline" style="width:100%; margin-top:10px; font-size:0.9rem" onclick="showAdDetails('${ad.id}')">التفاصيل</button>
                            ${adminBtns}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function getCategoryName(cat) {
            const map = {
                'vehicles': 'مركبات', 'real_estate': 'عقارات', 'electronics': 'إلكترونيات',
                'jobs': 'وظائف', 'services': 'خدمات', 'appliances': 'أجهزة منزلية',
                'fashion': 'موضة', 'professional': 'معدات', 'others': 'أخرى'
            };
            return map[cat] || cat;
        }

        // ==================== Feature/Filter Functions ====================

        window.applyFilters = () => {
            const cat = document.getElementById('filter-category').value;
            const city = document.getElementById('filter-city').value;
            const min = document.getElementById('filter-min-price').value;
            const max = document.getElementById('filter-max-price').value;

            let filtered = allAds.filter(ad => {
                let matchCat = (cat === 'all') || (ad.category === cat);
                let matchCity = (city === 'all') || (ad.city === city);
                let matchMin = (!min) || (ad.price >= parseFloat(min));
                let matchMax = (!max) || (ad.price <= parseFloat(max));
                return matchCat && matchCity && matchMin && matchMax;
            });

            renderAds(filtered);
            closeModal('filterModal');
            showToast('تم تطبيق الفلتر', 'success');
        };

        // ==================== Interaction Functions ====================
        
        window.showMarket = () => {
            document.getElementById('hero').style.display = 'none';
            document.getElementById('market-section').classList.remove('hidden');
            if (allAds.length === 0) getAds();
            // Show FABs if logged in
            if (currentUser) document.getElementById('fab-actions').classList.remove('hidden');
        };

        window.showSection = (id) => {
            if (id === 'hero') {
                document.getElementById('hero').style.display = 'flex';
                document.getElementById('market-section').classList.add('hidden');
                document.getElementById('fab-actions').classList.add('hidden');
            }
        };

        window.checkAuthAndOpenAdd = () => {
            if (currentUser) {
                openModal('addAdModal');
            } else {
                showToast('يجب تسجيل الدخول أولاً', 'error');
                openModal('loginModal');
            }
        };

        window.showAdDetails = (id) => {
            const ad = allAds.find(a => a.id === id);
            if(!ad) return;

            const content = document.getElementById('details-content');
            
            // تحقق إذا كان المستخدم مسجل للدخول لرؤية الرقم
            let contactInfo = '';
            if (currentUser) {
                contactInfo = `
                    <div style="background:#f0f0f0; padding:15px; border-radius:5px; margin-top:15px;">
                        <p><strong>رقم الهاتف:</strong> <a href="tel:${ad.phone}">${ad.phone}</a></p>
                        <button class="btn btn-primary" style="margin-top:5px; width:100%">ابدأ الدردشة (قريباً)</button>
                    </div>
                `;
            } else {
                contactInfo = `
                    <div style="background:#ffeeba; padding:10px; border-radius:5px; margin-top:15px; text-align:center;">
                        <p style="color:#856404;">يجب تسجيل الدخول لرؤية معلومات الاتصال</p>
                        <button onclick="closeModal('detailsModal'); openModal('loginModal')" class="btn btn-primary" style="margin-top:5px;">تسجيل دخول</button>
                    </div>
                `;
            }

            content.innerHTML = `
                <img src="${ad.imageUrl}" style="width:100%; border-radius:8px; max-height:300px; object-fit:contain; background:#eee;">
                <h2 style="margin:15px 0; color:var(--secondary)">${ad.title}</h2>
                <h3 style="color:var(--primary);">${ad.price.toLocaleString()} DZD</h3>
                <p style="color:#666; font-size:0.9rem; margin:5px 0;"><i class="fas fa-map-marker-alt"></i> ${ad.city} | ${getCategoryName(ad.category)}</p>
                <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
                <p style="line-height:1.6;">${ad.description}</p>
                ${contactInfo}
            `;
            openModal('detailsModal');
        };

        // ==================== Admin Functions ====================
        
        window.deleteAd = async (id) => {
            if(!confirm('هل أنت متأكد من حذف هذا الإعلان؟')) return;
            try {
                await deleteDoc(doc(db, "ads", id));
                showToast('تم حذف الإعلان', 'success');
                getAds();
            } catch (e) {
                console.error(e);
            }
        };

        window.toggleFeatured = async (id, status) => {
            try {
                await updateDoc(doc(db, "ads", id), {
                    isFeatured: status
                });
                showToast('تم تحديث الحالة', 'success');
                getAds();
            } catch (e) {
                console.error(e);
            }
        };

        // ==================== UI Helper Functions ====================
        
        window.openModal = (id) => { document.getElementById(id).classList.add('active'); };
        window.closeModal = (id) => { document.getElementById(id).classList.remove('active'); };
        
        window.showToast = (msg, type) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.className = `toast ${type}`;
            t.style.display = 'block';
            setTimeout(() => { t.style.display = 'none'; }, 3000);
        };

        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }
    </script>
</body>
</html>

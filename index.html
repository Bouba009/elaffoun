<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Affroun Online | العفرون أونلاين</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ==================== 1. Design System (1001dlala Style) ==================== */
        :root {
            --primary-blue: #0056b3; /* الأزرق الرسمي */
            --primary-orange: #ff7f00; /* البرتقالي للأزرار */
            --bg-body: #f2f4f8; /* خلفية رمادية فاتحة */
            --white: #ffffff;
            --text-dark: #222;
            --text-gray: #666;
            --border-color: #ddd;
            --radius: 4px; /* زوايا حادة قليلاً مثل المواقع الرسمية */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-dark); display: flex; flex-direction: column; min-height: 100vh; }
        a { text-decoration: none; color: inherit; transition: 0.2s; }
        ul { list-style: none; }
        button, input, select, textarea { outline: none; font-family: inherit; }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .hidden { display: none !important; }

        /* ==================== 2. Header Structure ==================== */
        
        /* Top Bar (Small) */
        .top-bar { background: #f8f9fa; border-bottom: 1px solid var(--border-color); font-size: 0.85rem; padding: 5px 0; color: var(--text-gray); }
        .top-bar .container { display: flex; justify-content: space-between; align-items: center; }
        .top-links a { margin-left: 15px; }
        .top-links a:hover { color: var(--primary-blue); }

        /* Main Header */
        header { background: var(--white); border-bottom: 1px solid var(--border-color); padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .header-content { display: flex; align-items: center; justify-content: space-between; gap: 20px; }

        /* Logo */
        .logo { font-size: 1.8rem; font-weight: 800; color: var(--primary-blue); line-height: 1; display: flex; flex-direction: column; }
        .logo span { font-size: 0.8rem; color: var(--primary-orange); letter-spacing: 1px; }

        /* Search Bar (Center) */
        .search-box { flex: 1; max-width: 600px; display: flex; border: 2px solid var(--primary-blue); border-radius: var(--radius); overflow: hidden; }
        .search-box input { flex: 1; padding: 10px 15px; border: none; font-size: 1rem; }
        .search-box button { background: var(--primary-blue); color: white; border: none; padding: 0 25px; cursor: pointer; font-size: 1.1rem; }
        .search-box button:hover { background: #004494; }

        /* Actions (Right) */
        .header-actions { display: flex; align-items: center; gap: 15px; }
        .btn-publish {
            background: var(--primary-orange); color: white; padding: 10px 20px; 
            border-radius: var(--radius); font-weight: 700; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 2px 5px rgba(255, 127, 0, 0.3); border: none; cursor: pointer;
        }
        .btn-publish:hover { background: #e67300; }
        
        .auth-link { display: flex; align-items: center; gap: 5px; font-weight: 600; cursor: pointer; color: var(--text-dark); }
        .auth-link:hover { color: var(--primary-blue); }

        /* Categories Bar */
        .categories-nav { background: var(--white); border-bottom: 1px solid var(--border-color); overflow-x: auto; white-space: nowrap; }
        .categories-nav .container { display: flex; }
        .cat-link { padding: 12px 20px; font-size: 0.95rem; font-weight: 600; color: var(--text-dark); border-bottom: 3px solid transparent; cursor: pointer; }
        .cat-link:hover, .cat-link.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); background: #f9fbff; }

        /* ==================== 3. Main Content ==================== */
        .main-wrapper { padding: 30px 0; flex: 1; }
        
        /* Banner Area */
        .banner-area { background: #ddd; height: 120px; width: 100%; border-radius: var(--radius); margin-bottom: 25px; display: none; overflow: hidden; }
        .banner-area img { width: 100%; height: 100%; object-fit: cover; }

        /* Controls Bar (Filter/Sort) */
        .controls-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: var(--radius); border: 1px solid var(--border-color); }
        .page-title { font-size: 1.3rem; font-weight: 700; color: var(--text-dark); }

        /* Ads Grid */
        .ads-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: 20px; }

        /* Ad Card (Clean Style) */
        .ad-card {
            background: white; border: 1px solid var(--border-color); border-radius: var(--radius);
            overflow: hidden; transition: 0.3s; position: relative; cursor: pointer;
            display: flex; flex-direction: column;
        }
        .ad-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: #ccc; }
        
        .ad-img-wrapper { height: 160px; width: 100%; position: relative; background: #eee; }
        .ad-img-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        .ad-badge { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 2px; }
        
        .ad-body { padding: 12px; flex: 1; display: flex; flex-direction: column; }
        .ad-price { font-size: 1.1rem; font-weight: 700; color: var(--primary-orange); margin-bottom: 5px; }
        .ad-title { font-size: 0.95rem; font-weight: 600; color: #333; line-height: 1.4; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; flex: 1; }
        .ad-info { font-size: 0.8rem; color: #888; display: flex; justify-content: space-between; margin-top: auto; border-top: 1px solid #f0f0f0; padding-top: 8px; }

        /* Featured Badge */
        .is-featured { border: 1px solid #ffc107; }
        .featured-star { position: absolute; top: 10px; left: 10px; color: #ffc107; background: #fff; padding: 5px; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 2; }

        /* ==================== 4. Modals ==================== */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal.active { opacity: 1; pointer-events: all; }
        .modal-content {
            background: white; width: 95%; max-width: 500px; padding: 0;
            border-radius: 6px; position: relative; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; }
        .modal-header h3 { font-size: 1.1rem; }
        .close-modal { font-size: 1.5rem; cursor: pointer; color: #777; }
        .modal-body { padding: 20px; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.95rem; }
        .form-control:focus { border-color: var(--primary-blue); }
        .btn-full { width: 100%; padding: 12px; background: var(--primary-blue); color: white; border: none; border-radius: 4px; font-weight: 700; cursor: pointer; }
        .btn-full:hover { background: #004494; }

        /* Loader Overlay */
        .loader-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-blue);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 12px 25px; border-radius: 30px;
            z-index: 3000; font-size: 0.9rem; display: none;
        }
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }

        /* Footer */
        footer { background: #f8f9fa; border-top: 1px solid var(--border-color); padding: 40px 0 20px; margin-top: auto; }
        .footer-links { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; font-size: 0.9rem; }
        .copyright { text-align: center; color: #777; font-size: 0.85rem; }
        .admin-trigger { color: #f8f9fa; cursor: pointer; } /* شبه مخفي */
        .admin-trigger:hover { color: #ccc; }

        /* Admin Controls */
        .admin-controls { display: flex; gap: 5px; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; }
        .btn-adm { font-size: 0.75rem; padding: 3px 8px; border-radius: 3px; cursor: pointer; color: white; border: none; }

        /* Responsive */
        @media (max-width: 768px) {
            .top-bar { display: none; }
            .header-content { flex-direction: column; gap: 10px; }
            .search-box { width: 100%; order: 3; }
            .logo { align-self: flex-start; }
            .header-actions { position: absolute; top: 15px; left: 15px; }
            .btn-publish span { display: none; } /* Hide text on mobile */
            .btn-publish { padding: 8px 12px; }
        }
    </style>
</head>
<body>

    <div id="toast" class="toast"></div>

    <!-- Top Bar -->
    <div class="top-bar">
        <div class="container">
            <div class="date-display">الجزائر، العفرون</div>
            <div class="top-links">
                <a href="#">من نحن</a>
                <a href="#">إتصل بنا</a>
                <a href="#">المساعدة</a>
            </div>
        </div>
    </div>

    <!-- Main Header -->
    <header>
        <div class="container header-content">
            <!-- Logo -->
            <a href="#" onclick="window.location.reload()" class="logo">
                EL AFFROUN
                <span>ONLINE MARKET</span>
            </a>

            <!-- Search -->
            <div class="search-box">
                <input type="text" id="search-input" placeholder="ابحث عن منتج، فئة، ماركة...">
                <button onclick="performSearch()"><i class="fas fa-search"></i></button>
            </div>

            <!-- Actions -->
            <div class="header-actions">
                <div id="guest-nav" class="auth-link" onclick="openModal('loginModal')">
                    <i class="far fa-user"></i> <span>دخول</span>
                </div>
                <div id="user-nav" class="auth-link hidden" onclick="logoutUser()">
                    <i class="fas fa-user-check" style="color: green;"></i> <span id="user-name-display">حسابي</span>
                </div>
                <button class="btn-publish" onclick="checkAuthAndOpenAdd()">
                    <i class="fas fa-plus-circle"></i>
                    <span>ضع إعلانك مجاناً</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Categories Navigation -->
    <nav class="categories-nav">
        <div class="container">
            <div class="cat-link active" onclick="filterByCat('all', this)">الكل</div>
            <div class="cat-link" onclick="filterByCat('vehicles', this)">سيارات</div>
            <div class="cat-link" onclick="filterByCat('real_estate', this)">عقارات</div>
            <div class="cat-link" onclick="filterByCat('electronics', this)">إلكترونيات</div>
            <div class="cat-link" onclick="filterByCat('phones', this)">هواتف</div>
            <div class="cat-link" onclick="filterByCat('home', this)">منزل</div>
            <div class="cat-link" onclick="filterByCat('fashion', this)">موضة</div>
            <div class="cat-link" onclick="filterByCat('services', this)">خدمات</div>
            <div class="cat-link" onclick="filterByCat('others', this)">أخرى</div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-wrapper">
        <div class="container">
            
            <!-- Admin Banner -->
            <div id="top-banner" class="banner-area">
                <a href="#" id="banner-link" target="_blank"><img id="banner-img" src="" alt="Advertisement"></a>
            </div>

            <!-- Filter/Sort Bar -->
            <div class="controls-bar">
                <div class="page-title" id="page-title">أحدث الإعلانات</div>
                <button class="btn-publish" style="background: white; color: #666; border: 1px solid #ddd; box-shadow: none;" onclick="openModal('filterModal')">
                    <i class="fas fa-filter"></i> فلترة متقدمة
                </button>
            </div>

            <!-- Loader -->
            <div id="loading-spinner" style="text-align: center; padding: 40px;">
                <div class="spinner" style="margin: 0 auto;"></div>
            </div>

            <!-- Ads Grid -->
            <div id="ads-container" class="ads-grid"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-links">
                <a href="#">شروط الاستخدام</a>
                <a href="#">سياسة الخصوصية</a>
                <a href="#">قواعد السلامة</a>
                <a href="#">خريطة الموقع</a>
            </div>
            <div class="copyright">
                &copy; 2024 El Affroun Online. جميع الحقوق محفوظة. 
                <span class="admin-trigger" onclick="openModal('adminLoginModal')"><i class="fas fa-lock"></i></span>
            </div>
        </div>
    </footer>

    <!-- ==================== MODALS ==================== -->

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>تسجيل الدخول</h3>
                <span class="close-modal" onclick="closeModal('loginModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label>البريد الإلكتروني</label>
                        <input type="email" id="login-email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>كلمة المرور</label>
                        <input type="password" id="login-password" class="form-control" required>
                    </div>
                    <button type="submit" class="btn-full">دخول</button>
                    <p style="margin-top: 15px; text-align: center; font-size: 0.9rem;">
                        لا تملك حساباً؟ <a href="#" onclick="closeModal('loginModal'); openModal('signupModal')" style="color: var(--primary-blue);">سجل الآن</a>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>إنشاء حساب جديد</h3>
                <span class="close-modal" onclick="closeModal('signupModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="signupForm">
                    <div class="form-group">
                        <label>الاسم الكامل</label>
                        <input type="text" id="reg-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>البريد الإلكتروني</label>
                        <input type="email" id="reg-email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>رقم الهاتف</label>
                        <input type="text" id="reg-phone" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>كلمة المرور</label>
                        <input type="password" id="reg-pass" class="form-control" required>
                    </div>
                    <button type="submit" class="btn-full">تسجيل</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Ad Modal -->
    <div id="addAdModal" class="modal">
        <div class="modal-content">
            <div id="upload-overlay" class="loader-overlay hidden">
                <div class="spinner"></div>
                <p style="margin-top: 15px; font-weight: bold;">جاري النشر...</p>
            </div>
            <div class="modal-header">
                <h3>إضافة إعلان جديد</h3>
                <span class="close-modal" onclick="closeModal('addAdModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addAdForm">
                    <div class="form-group">
                        <label>عنوان الإعلان</label>
                        <input type="text" id="ad-title" class="form-control" placeholder="مثال: سيارة رينو 2018 نظيفة" required>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex:1">
                            <label>الفئة</label>
                            <select id="ad-category" class="form-control" required>
                                <option value="vehicles">سيارات و مركبات</option>
                                <option value="real_estate">عقارات</option>
                                <option value="electronics">إلكترونيات</option>
                                <option value="phones">هواتف</option>
                                <option value="home">منزل و أثاث</option>
                                <option value="fashion">ألبسة</option>
                                <option value="services">خدمات</option>
                                <option value="others">أخرى</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex:1">
                            <label>المدينة</label>
                            <select id="ad-city" class="form-control" required>
                                <option value="العفرون">العفرون</option>
                                <option value="موزاية">موزاية</option>
                                <option value="شفة">شفة</option>
                                <option value="واد جر">واد جر</option>
                                <option value="احمر العين">احمر العين</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>السعر (DZD)</label>
                        <input type="number" id="ad-price" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>رقم الهاتف</label>
                        <input type="text" id="ad-phone" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>التفاصيل</label>
                        <textarea id="ad-desc" class="form-control" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>صورة</label>
                        <input type="file" id="ad-image" class="form-control" accept="image/*" required>
                    </div>
                    
                    <!-- Admin Only Checkbox -->
                    <div id="admin-options" class="hidden" style="background: #fff3cd; padding: 10px; margin-bottom: 10px; border-radius: 4px;">
                        <label style="margin:0; cursor:pointer;">
                            <input type="checkbox" id="is-admin-ad"> إعلان مثبت / بانر (Admin)
                        </label>
                    </div>

                    <button type="submit" class="btn-full" style="background: var(--primary-orange);">نشر الإعلان</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Filter Modal -->
    <div id="filterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>فلترة البحث</h3>
                <span class="close-modal" onclick="closeModal('filterModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>المدينة</label>
                    <select id="filter-city" class="form-control">
                        <option value="all">كل المدن</option>
                        <option value="العفرون">العفرون</option>
                        <option value="موزاية">موزاية</option>
                        <option value="شفة">شفة</option>
                        <option value="واد جر">واد جر</option>
                    </select>
                </div>
                <div style="display:flex; gap:10px;">
                    <div class="form-group" style="flex:1">
                        <label>السعر الأدنى</label>
                        <input type="number" id="filter-min" class="form-control" placeholder="0">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label>السعر الأقصى</label>
                        <input type="number" id="filter-max" class="form-control" placeholder="MAX">
                    </div>
                </div>
                <button onclick="applyFilters()" class="btn-full">تطبيق</button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>تفاصيل الإعلان</h3>
                <span class="close-modal" onclick="closeModal('detailsModal')">&times;</span>
            </div>
            <div class="modal-body" id="details-content">
                <!-- Content injected here -->
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-header">
                <h3>Admin Access</h3>
                <span class="close-modal" onclick="closeModal('adminLoginModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="adminForm">
                    <div class="form-group"><input type="text" id="admin-user" class="form-control" placeholder="User" required></div>
                    <div class="form-group"><input type="password" id="admin-pass" class="form-control" placeholder="Pass" required></div>
                    <button type="submit" class="btn-full" style="background:#333">Login</button>
                </form>
            </div>
        </div>
    </div>

    <!-- ==================== LOGIC ==================== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAaXp-gUOQ_G2s-kM8JhaqW8TJcJ4Nqcuo",
            authDomain: "comondi-fae4b.firebaseapp.com",
            projectId: "comondi-fae4b",
            storageBucket: "comondi-fae4b.firebasestorage.app",
            messagingSenderId: "932777870241",
            appId: "1:932777870241:web:78b0cf3a3cf14046be01e0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentUser = null;
        let isAdmin = false;
        let allAds = [];
        let currentCategory = 'all';

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('guest-nav').classList.add('hidden');
                document.getElementById('user-nav').classList.remove('hidden');
                document.getElementById('user-name-display').innerText = user.email.split('@')[0];
                
                // Admin Check
                if(user.email === 'admin@elaffroun.com') {
                    isAdmin = true;
                    document.getElementById('admin-options').classList.remove('hidden');
                } else {
                    isAdmin = false;
                    document.getElementById('admin-options').classList.add('hidden');
                }
            } else {
                currentUser = null;
                isAdmin = false;
                document.getElementById('guest-nav').classList.remove('hidden');
                document.getElementById('user-nav').classList.add('hidden');
                document.getElementById('admin-options').classList.add('hidden');
            }
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value);
                closeModal('loginModal');
                showToast('مرحباً بعودتك!', 'success');
            } catch (err) { showToast('خطأ: ' + err.message, 'error'); }
        });

        // Signup
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await createUserWithEmailAndPassword(auth, document.getElementById('reg-email').value, document.getElementById('reg-pass').value);
                closeModal('signupModal');
                showToast('تم إنشاء الحساب', 'success');
            } catch (err) { showToast(err.message, 'error'); }
        });

        // Admin Secret Login
        document.getElementById('adminForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const u = document.getElementById('admin-user').value;
            const p = document.getElementById('admin-pass').value;
            if (u === 'admin' && p === 'abobob123') {
                try {
                    await signInWithEmailAndPassword(auth, "admin@elaffroun.com", "abobob123");
                    closeModal('adminLoginModal');
                    showToast('Admin Mode Active', 'success');
                } catch {
                    // Create if not exists
                    await createUserWithEmailAndPassword(auth, "admin@elaffroun.com", "abobob123");
                    closeModal('adminLoginModal');
                }
            } else { showToast('Access Denied', 'error'); }
        });

        window.logoutUser = () => signOut(auth).then(() => window.location.reload());

        // --- ADS ---
        async function loadAds() {
            const container = document.getElementById('ads-container');
            document.getElementById('loading-spinner').style.display = 'block';
            container.innerHTML = '';

            try {
                const q = query(collection(db, "ads"), orderBy("createdAt", "desc"));
                const snap = await getDocs(q);
                allAds = [];
                snap.forEach(d => allAds.push({id: d.id, ...d.data()}));
                
                // Show Admin Banner
                const banner = allAds.find(a => a.isAdminAd);
                if(banner) {
                    document.getElementById('top-banner').style.display = 'block';
                    document.getElementById('banner-img').src = banner.imageUrl;
                }

                renderAds(allAds);
            } catch (e) { console.error(e); }
            finally { document.getElementById('loading-spinner').style.display = 'none'; }
        }

        function renderAds(list) {
            const container = document.getElementById('ads-container');
            container.innerHTML = '';
            
            if(list.length === 0) {
                container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px; color:#888">لا توجد إعلانات مطابقة</div>';
                return;
            }

            list.forEach(ad => {
                const featuredClass = ad.isFeatured ? 'is-featured' : '';
                const star = ad.isFeatured ? '<i class="fas fa-star featured-star"></i>' : '';
                
                let adminControls = '';
                if(isAdmin) {
                    adminControls = `
                        <div class="admin-controls">
                            <button onclick="deleteAd('${ad.id}')" class="btn-adm" style="background:#dc3545">حذف</button>
                            <button onclick="toggleFeat('${ad.id}', ${!ad.isFeatured})" class="btn-adm" style="background:#ffc107; color:black">تثبيت</button>
                        </div>
                    `;
                }

                const html = `
                    <div class="ad-card ${featuredClass}" onclick="showDetails('${ad.id}')">
                        ${star}
                        <div class="ad-img-wrapper">
                            <img src="${ad.imageUrl}" loading="lazy" alt="ad">
                            <span class="ad-badge">${ad.city}</span>
                        </div>
                        <div class="ad-body">
                            <div class="ad-price">${Number(ad.price).toLocaleString()} DA</div>
                            <div class="ad-title">${ad.title}</div>
                            <div class="ad-info">
                                <span>${translateCat(ad.category)}</span>
                                <span><i class="far fa-clock"></i> الآن</span>
                            </div>
                            <div onclick="event.stopPropagation()">
                                ${adminControls}
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // --- PUBLISH ---
        document.getElementById('addAdForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { openModal('loginModal'); return; }

            const overlay = document.getElementById('upload-overlay');
            overlay.classList.remove('hidden');

            try {
                const file = document.getElementById('ad-image').files[0];
                const storageRef = ref(storage, 'ads/' + Date.now() + '_' + file.name);
                const snap = await uploadBytes(storageRef, file);
                const url = await getDownloadURL(snap.ref);

                await addDoc(collection(db, "ads"), {
                    title: document.getElementById('ad-title').value,
                    price: Number(document.getElementById('ad-price').value),
                    category: document.getElementById('ad-category').value,
                    city: document.getElementById('ad-city').value,
                    phone: document.getElementById('ad-phone').value,
                    description: document.getElementById('ad-desc').value,
                    imageUrl: url,
                    userId: currentUser.uid,
                    createdAt: serverTimestamp(),
                    isAdminAd: isAdmin && document.getElementById('is-admin-ad').checked,
                    isFeatured: isAdmin && document.getElementById('is-admin-ad').checked
                });

                document.getElementById('addAdForm').reset();
                closeModal('addAdModal');
                showToast('تم النشر بنجاح', 'success');
                loadAds();
            } catch (err) {
                console.error(err);
                showToast('فشل النشر: ' + err.message, 'error');
            } finally {
                overlay.classList.add('hidden');
            }
        });

        // --- FILTERING ---
        window.filterByCat = (cat, elem) => {
            currentCategory = cat;
            document.querySelectorAll('.cat-link').forEach(l => l.classList.remove('active'));
            elem.classList.add('active');
            
            if(cat === 'all') {
                renderAds(allAds);
                document.getElementById('page-title').innerText = 'أحدث الإعلانات';
            } else {
                const filtered = allAds.filter(a => a.category === cat);
                renderAds(filtered);
                document.getElementById('page-title').innerText = elem.innerText;
            }
        };

        window.performSearch = () => {
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = allAds.filter(a => a.title.toLowerCase().includes(term));
            renderAds(filtered);
            document.getElementById('page-title').innerText = `نتائج البحث: ${term}`;
        };

        window.applyFilters = () => {
            const city = document.getElementById('filter-city').value;
            const min = document.getElementById('filter-min').value;
            const max = document.getElementById('filter-max').value;
            
            let res = allAds;
            if(city !== 'all') res = res.filter(a => a.city === city);
            if(min) res = res.filter(a => a.price >= min);
            if(max) res = res.filter(a => a.price <= max);
            
            renderAds(res);
            closeModal('filterModal');
        };

        // --- HELPERS ---
        window.showDetails = (id) => {
            const ad = allAds.find(a => a.id === id);
            if(!ad) return;

            let contact = '';
            if(currentUser) {
                contact = `
                    <div style="background:#eef; padding:15px; border-radius:4px; margin-top:20px; text-align:center">
                        <div style="font-size:1.4rem; font-weight:bold; color:var(--primary-blue)">${ad.phone}</div>
                        <a href="tel:${ad.phone}" class="btn-full" style="display:block; margin-top:10px; background:var(--primary-orange)">اتصل الآن</a>
                    </div>
                `;
            } else {
                contact = `
                    <div style="padding:15px; border:1px dashed #ccc; margin-top:20px; text-align:center">
                        <p>لرؤية رقم الهاتف، يرجى تسجيل الدخول</p>
                        <button onclick="closeModal('detailsModal'); openModal('loginModal')" class="btn-full" style="margin-top:10px">دخول</button>
                    </div>
                `;
            }

            document.getElementById('details-content').innerHTML = `
                <img src="${ad.imageUrl}" style="width:100%; border-radius:4px; margin-bottom:15px">
                <h2 style="color:var(--primary-blue)">${ad.title}</h2>
                <h3 style="color:var(--primary-orange); margin:10px 0">${Number(ad.price).toLocaleString()} DA</h3>
                <div style="color:#666; margin-bottom:15px">
                    <i class="fas fa-map-marker-alt"></i> ${ad.city} | ${translateCat(ad.category)}
                </div>
                <hr style="border:0; border-top:1px solid #eee; margin:15px 0">
                <p style="line-height:1.6">${ad.description}</p>
                ${contact}
            `;
            openModal('detailsModal');
        };

        function translateCat(cat) {
            const map = {
                'vehicles': 'مركبات', 'real_estate': 'عقارات', 'electronics': 'إلكترونيات',
                'phones': 'هواتف', 'home': 'منزل', 'fashion': 'موضة', 'services': 'خدمات', 'others': 'أخرى'
            };
            return map[cat] || cat;
        }

        window.checkAuthAndOpenAdd = () => {
            if(currentUser) openModal('addAdModal');
            else { showToast('يجب تسجيل الدخول أولاً', 'error'); openModal('loginModal'); }
        };

        window.deleteAd = async (id) => { if(confirm('حذف؟')) { await deleteDoc(doc(db, "ads", id)); loadAds(); } };
        window.toggleFeat = async (id, s) => { await updateDoc(doc(db, "ads", id), {isFeatured: s}); loadAds(); };

        window.openModal = (id) => document.getElementById(id).classList.add('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
        window.showToast = (m, t) => {
            const toast = document.getElementById('toast');
            toast.innerText = m; toast.className = `toast ${t}`; toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        };

        // Init
        loadAds();
    </script>
</body>
</html>
